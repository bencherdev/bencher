---
title: "Iai"
description: "å¦‚ä½•ä½¿ç”¨Iaiå¯¹Rustä»£ç è¿›è¡ŒåŸºå‡†æµ‹è¯•çš„é€æ­¥æŒ‡å—"
heading: "å¦‚ä½•ä½¿ç”¨Iaiå¯¹Rustä»£ç è¿›è¡ŒåŸºå‡†æµ‹è¯•"
sortOrder: 3
---

import Benchmarking from "../../../chunks/benchmarking/zh/benchmarking.mdx";
import FizzBuzzRules from "../../../chunks/benchmarking/zh/fizz-buzz-rules.mdx";
import FizzBuzzRust from "../../../chunks/rust/zh/fizz-buzz-rust.mdx";
import StepByStepRust from "../../../chunks/rust/zh/step-by-step-rust.mdx";
import MicroVsMacro from "../../../chunks/benchmarking/zh/micro-vs-macro.mdx";
import BenchmarkingRust from "../../../chunks/rust/zh/benchmarking-rust.mdx";
import FizzBuzzRefactor from "../../../chunks/rust/criterion/zh/fizz-buzz-refactor.mdx";
import GameBenchesTree from "../../../chunks/rust/criterion/game-benches-tree.mdx";
import FizzBuzzRefactorBenchesCode from "../../../chunks/rust/iai/fizz-buzz-refactor-benches-code.mdx";
import GameCargoToml from "../../../chunks/rust/iai/game-cargo-toml.mdx";
import BenchPlayGameOutput from "../../../chunks/rust/iai/bench-play-game-output.mdx";
import FizzBuzzFibonacciRust from "../../../chunks/rust/zh/fizz-buzz-fibonacci-rust.mdx";
import PlayGameRustCode from "../../../chunks/rust/criterion/play-game-rust-code.mdx";
import BenchPlayGameFibonacciOutput from "../../../chunks/rust/iai/bench-play-game-fibonacci-output.mdx";
import FizzBuzzFibonacciOpenRust from "../../../chunks/rust/zh/fizz-buzz-fibonacci-open-rust.mdx";
import FizzBuzzFibonacciOpenRustCode from "../../../chunks/rust/criterion/fizz-buzz-fibonacci-open-rust-code.mdx";
import TheEnd from "../../../chunks/benchmarking/zh/the-end.mdx";
import OnFire from "../../../chunks/benchmarking/zh/on-fire.mdx";
import BenchPlayGameOnFireCode from "../../../chunks/rust/iai/bench-play-game-on-fire-code.mdx";
import BenchPlayGameOnFireOutputStart from "../../../chunks/rust/iai/bench-play-game-on-fire-output-start.mdx";
import BenchPlayGameOnFireOutput from "../../../chunks/rust/iai/bench-play-game-on-fire-output.mdx";
import FizzBuzzFibonacciFixRust from "../../../chunks/rust/zh/fizz-buzz-fibonacci-fix-rust.mdx";
import BenchPlayGameFixOutput from "../../../chunks/rust/iai/bench-play-game-fix-output.mdx";
import CatchInCi from "../../../chunks/benchmarking/zh/catch-in-ci.mdx";
import CatchInCiOutput from "../../../chunks/rust/iai/catch-in-ci-output.mdx";
import CatchInCiPlot from "../../../chunks/benchmarking/zh/catch-in-ci-plot.mdx";
import CatchInCiPlotRustBench from "../../../chunks/rust/catch-in-ci-plot-rust-bench.mdx";
import BencherFooter from "../../../chunks/learn/zh/bencher-footer.mdx";

<Benchmarking />

<FizzBuzzRust />

<StepByStepRust />

<MicroVsMacro />

<BenchmarkingRust />

ä¸‰è€…éƒ½è¢« [Bencher æ”¯æŒ](/docs/zh/explanation/adapters/)ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆé€‰æ‹©Iaiå‘¢ï¼Ÿ
Iaiä½¿ç”¨æŒ‡ä»¤è®¡æ•°è€Œéå¢™é’Ÿæ—¶é—´ã€‚
è¿™ä½¿å…¶ç†æƒ³çš„é€‚åˆ[æŒç»­æ€§åŸºå‡†æµ‹è¯•](/docs/zh/explanation/continuous-benchmarking/)ï¼Œä¹Ÿå°±æ˜¯åœ¨CIä¸­è¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚
æˆ‘å»ºè®®å¯¹äºæŒç»­åŒ–åŸºå‡†æµ‹è¯•ä½¿ç”¨Iaiï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ æ­£åœ¨ä½¿ç”¨å…±äº«çš„è¿è¡Œå™¨ã€‚
äº†è§£ä¸€ä»¶é‡è¦çš„äº‹æƒ…ï¼ŒIaiä»…æµ‹é‡ä½ çœŸæ­£å…³å¿ƒä¹‹äº‹çš„ä»£ç†ã€‚
ä½ çš„åº”ç”¨ç¨‹åºçš„å»¶è¿Ÿæ˜¯å¦ä¼šå› ä»1000ä¸ªæŒ‡ä»¤å¢åŠ åˆ°2000ä¸ªæŒ‡ä»¤è€ŒåŠ å€ï¼Ÿ
å¯èƒ½ä¼šä¹Ÿå¯èƒ½ä¸ä¼šã€‚
å› æ­¤ï¼Œä¸åŸºäºæŒ‡ä»¤è®¡æ•°çš„åŸºå‡†æµ‹è¯•å¹¶è¡Œè¿è¡ŒåŸºäºå¢™é’Ÿæ—¶é—´çš„åŸºå‡†æµ‹è¯•å¯èƒ½ä¼šæ¯”è¾ƒæœ‰ç”¨ã€‚

> ğŸ° Iai å·²ç»è¶…è¿‡3å¹´æ²¡æœ‰æ›´æ–°äº†ï¼ˆæŸ¥çœ‹ [è¿™é‡Œ](https://github.com/bheisler/iai/commits/main/)ï¼‰ã€‚æ‰€ä»¥ä½ å¯èƒ½éœ€è¦è€ƒè™‘[ä½¿ç”¨ Iai-Callgrind](/docs/zh/explanation/adapters/#-rust-iai-callgrind) æ›¿ä»£ã€‚

## å®‰è£… Valgrind

Iaiä½¿ç”¨ä¸€ä¸ªå«åš [Valgrind](https://valgrind.org/) çš„å·¥å…·æ”¶é›†æŒ‡ä»¤è®¡æ•°ã€‚
Valgrindæ”¯æŒLinuxï¼ŒSolarisï¼ŒFreeBSDå’ŒMacOSã€‚
ç„¶è€Œï¼ŒMacOS æ˜¯é™å”®x86_64å¤„ç†å™¨ï¼Œ[arm64 (M1, M2, etc) å¤„ç†å™¨ç›®å‰ä¸æ”¯æŒ](https://github.com/LouisBrunner/valgrind-macos/issues/56)ã€‚

åœ¨ Debian ä¸Šè¿è¡Œï¼š`sudo apt-get install valgrind`

åœ¨ MacOS ï¼ˆä»…é™x86_64/IntelèŠ¯ç‰‡ï¼‰ä¸Šï¼š`brew install valgrind`

<FizzBuzzRefactor />

## å¯¹FizzBuzzè¿›è¡ŒåŸºå‡†æµ‹è¯•

ä¸ºäº†æµ‹è¯•æˆ‘ä»¬çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ª `benches` æ–‡ä»¶å¤¹å¹¶æ·»åŠ æ–‡ä»¶æ¥è®°å½•æˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ï¼Œ `play_game.rs`:

<GameBenchesTree />

åœ¨ `play_game.rs` æ–‡ä»¶é‡Œæ·»åŠ ä¸‹åˆ—ä»£ç ï¼š

<FizzBuzzRefactorBenchesCode />

- å¯¼å…¥æˆ‘ä»¬ `game` åŒ…ä¸­çš„ `play_game` å‡½æ•°ã€‚
- åˆ›å»ºåä¸º `bench_play_game` çš„å‡½æ•°ã€‚
- åœ¨"black box"é‡Œè¿è¡Œæˆ‘ä»¬çš„å®åŸºå‡†ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±ä¸ä¼šä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚
- ä» `1` åˆ° `100` è¿›è¡Œè¿­ä»£ã€‚
- å¯¹æ¯ä¸ªæ•°å­—ï¼Œè°ƒç”¨ `play_game`ï¼Œå°†æ‰“å°è®¾ç½®ä¸º `false`ã€‚

ç°åœ¨æˆ‘ä»¬éœ€è¦é…ç½® `game` åŒ…ä»¥è¿è¡Œæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ã€‚

åœ¨ä½ çš„ `Cargo.toml` æ–‡ä»¶åº•éƒ¨æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

<GameCargoToml />

- `iai`ï¼šå°† `iai` æ·»åŠ ä¸ºå¼€å‘ä¾èµ–é¡¹ï¼Œå› ä¸ºæˆ‘ä»¬ä»…åœ¨æ€§èƒ½æµ‹è¯•ä¸­ä½¿ç”¨å®ƒã€‚
- `bench`ï¼šæ³¨å†Œ `play_game` ä½œä¸ºåŸºå‡†æµ‹è¯•å¹¶å°† `harness` è®¾ç½®ä¸º `false`ï¼Œå› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨ Iai ä½œä¸ºæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•æ¡†æ¶ã€‚

ç°åœ¨æˆ‘ä»¬å·²å‡†å¤‡å¥½å¯¹ä»£ç è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œè¿è¡Œ `cargo bench`ï¼š

<BenchPlayGameOutput />

> ğŸ° å¼€å§‹å‡æ¸©å§ï¼æˆ‘ä»¬å¾—åˆ°äº†æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡åŸºå‡†æµ‹è¯•æ•°æ®ï¼

ç»ˆäºï¼Œæˆ‘ä»¬å¯ä»¥ä¼‘æ¯ä¸‹æˆ‘ä»¬ç–²æƒ«çš„å¼€å‘è€…å¤´è„‘äº†...
å¼€ä¸ªç©ç¬‘ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·éœ€è¦ä¸€ä¸ªæ–°çš„ç‰¹æ€§ï¼

<FizzBuzzFibonacciRust>
  <PlayGameRustCode />
</FizzBuzzFibonacciRust>

## å¯¹FizzBuzzFibonacciè¿›è¡ŒåŸºå‡†æµ‹è¯•

ç°åœ¨æˆ‘ä»¬å¯ä»¥é‡æ–°è¿è¡Œæˆ‘ä»¬çš„åŸºå‡†æµ‹è¯•ï¼š

<BenchPlayGameFibonacciOutput />

å“¦ï¼Œå¤ªæ£’äº†ï¼Iai å‘Šè¯‰æˆ‘ä»¬ï¼ŒFizzBuzz å’Œ FizzBuzzFibonacci æ¸¸æˆä¹‹é—´é¢„è®¡å‘¨æœŸçš„åŒºåˆ«æ˜¯ `+522.6091%`ã€‚
ä½ çš„ç»“æœä¼šç¨å¾®æœ‰äº›ä¸åŒäºæˆ‘çš„ã€‚
ç„¶è€Œï¼Œä¸¤æ¬¾æ¸¸æˆä¹‹é—´çš„åŒºåˆ«å¯èƒ½åœ¨ `5x` å·¦å³ã€‚
æˆ‘è§‰å¾—è¿™å·²ç»å¾ˆå¥½äº†ï¼å°¤å…¶æ˜¯å¯¹äºå¢åŠ ä¸€ä¸ªå¬èµ·æ¥å¾ˆé«˜çº§çš„ _æ–æ³¢é‚£å¥‘æ•°åˆ—_ åŠŸèƒ½åˆ°æˆ‘ä»¬çš„æ¸¸æˆä¸­ã€‚
å­©å­ä»¬ä¸€å®šä¼šå–œæ¬¢å®ƒçš„ï¼

<FizzBuzzFibonacciOpenRust>
  <FizzBuzzFibonacciOpenRustCode />
</FizzBuzzFibonacciOpenRust>

<TheEnd />

<br />

<OnFire />

<BenchPlayGameOnFireCode />

- `bench_play_game_100` å¾®åŸºå‡†æµ‹è¯•ç”¨äºæ’­æ”¾æ¸¸æˆæ•°å­—ä¸€ç™¾ (`100`)
- `bench_play_game_1_000_000` å¾®åŸºå‡†æµ‹è¯•ç”¨äºæ’­æ”¾æ¸¸æˆæ•°å­—ä¸€ç™¾ä¸‡ (`1_000_000`)

å½“æˆ‘è¿è¡Œå®ƒï¼Œæˆ‘å¾—åˆ°è¿™ä¸ªï¼š

<BenchPlayGameOnFireOutputStart />

ç­‰å¾…ä¸€ä¸‹... ç­‰å¾…ä¸€ä¸‹...

<BenchPlayGameOnFireOutput />

ç­‰ç­‰ï¼ `6,685 é¢„è®¡å‘¨æœŸ` x `1,000` åº”è¯¥æ˜¯ `6,685,000 é¢„è®¡å‘¨æœŸ` ä¸æ˜¯ `155,109,206 é¢„è®¡å‘¨æœŸ` ğŸ¤¯
å°½ç®¡æˆ‘å¾—åˆ°äº†æˆ‘çš„æ–æ³¢é‚£å¥‘æ•°åˆ—ä»£ç åŠŸèƒ½æ­£ç¡®ï¼Œæˆ‘ä¸€å®šåœ¨æŸå¤„æœ‰æ€§èƒ½çš„bugã€‚

<FizzBuzzFibonacciFixRust />

ç°åœ¨è®©æˆ‘ä»¬é‡æ–°è¿è¡Œé‚£äº›åŸºå‡†æµ‹è¯•ï¼Œçœ‹çœ‹æˆ‘ä»¬åšçš„å¦‚ä½•ï¼š

<BenchPlayGameFixOutput />

å“¦ï¼Œå“‡ï¼æˆ‘ä»¬çš„ `bench_play_game` åŸºå‡†æµ‹è¯•å›å½’åˆ°äº†ä¸æœ€åˆçš„ FizzBuzz ç›¸å…³çš„æ°´å¹³é™„è¿‘ã€‚
æˆ‘çœŸå¸Œæœ›æˆ‘èƒ½è®°ä½é‚£ä¸ªåˆ†æ•°æ˜¯å¤šå°‘ã€‚ä½†å·²ç»è¿‡å»ä¸‰ä¸ªæ˜ŸæœŸäº†ã€‚
æˆ‘çš„ç»ˆç«¯å†å²å·²ç»æ‰¾ä¸åˆ°äº†ã€‚
è€Œä¸” Iai åªæ˜¯ä¸æœ€è¿‘çš„ç»“æœè¿›è¡Œæ¯”è¾ƒã€‚
ä½†æ˜¯æˆ‘æƒ³åº”è¯¥å·®ä¸å¤šï¼

`bench_play_game_100` åŸºå‡†æµ‹è¯•å‡ ä¹ä¸‹é™äº†10å€ï¼Œ `-87.22513%`ã€‚
è€Œ `bench_play_game_1_000_000` åŸºå‡†æµ‹è¯•ä¸‹é™äº†è¶…è¿‡10,000å€ï¼ä» `155,109,206 é¢„è®¡å‘¨æœŸ` åˆ° `950 é¢„è®¡å‘¨æœŸ`ï¼
é‚£æ˜¯ `-99.99939%`ï¼

> ğŸ° å—¯ï¼Œè‡³å°‘æˆ‘ä»¬åœ¨è¿™ä¸ªæ€§èƒ½bugè¿›å…¥ç”Ÿäº§ä¹‹å‰å‘ç°äº†å®ƒ... å™¢ï¼Œå¯¹äº†ï¼Œå·²ç»å¿˜äº†...

<CatchInCi />

<CatchInCiOutput />

<CatchInCiPlot />

<CatchInCiPlotRustBench title="å¦‚ä½•ä½¿ç”¨Iaiå¯¹Rustè¿›è¡ŒåŸºå‡†æµ‹è¯•" />

<BencherFooter />
