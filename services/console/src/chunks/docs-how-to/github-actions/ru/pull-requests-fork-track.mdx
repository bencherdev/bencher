import PullRequestsForkTrackCode from "../pull-requests-fork-track-code.mdx";

<PullRequestsForkTrackCode />

1. Создайте первый файл `workflow` для GitHub Actions.
   (например, `.github/workflows/fork_pr_benchmarks_track.yml`)
2. Назовите этот workflow вторым workflow.
   (например, `name: Track Benchmarks with Bencher`)
3. Свяжите два workflow с помощью
   [события `workflow_run`][github actions workflow_run].
   (например, `on: workflow_run: ...`)
4. Создайте `job` для GitHub Actions.
   (например, `jobs: track_fork_pr_branch`)
5. Выполните эту задачу только в случае успешного завершения предыдущего workflow, используя
   [событие `workflow_run` GitHub Actions][github actions workflow_run].
   (например, `if: github.event.workflow_run.conclusion == 'success'`)
6. Установите [разрешения для `GITHUB_TOKEN`][github token permissions]
   на `write` для `pull-requests`.
   В зависимости от ваших настроек GitHub, это может не требоваться.
   Однако для всех организаций и персональных репозиториев,
   [созданных после 02 февраля 2023 года][github token read only],
   это поведение по умолчанию.
   Полный обзор см. в [документации GitHub][github token permissions security].
   (например, `permissions: pull-requests: write`)
7. Установите тип компьютера, на котором будет выполняться задача.
   Полный обзор см. в [документации `runs-on` для GitHub Actions][github actions runs-on].
   (например, `runs-on: ubuntu-latest`)
8. Задайте результаты бенчмарков и файлы объектов события `pull_request` в качестве переменных среды.
   (например, `env: ...`)
9. Скачайте кешированные результаты бенчмарков и событие `pull_request`
   с помощью [GitHub Action `action-download-artifact`][action download artifact].
   (например, `uses: dawidd6/action-download-artifact@v6`)
10. Экспортируйте необходимые данные из события `pull_request` как [промежуточные переменные среды][github intermediate environment variable].
    (например, `core.exportVariable(...)`)
11. Установите Bencher CLI с помощью [GitHub Action][bencher cli github action].
   (например, `uses: bencherdev/bencher@main`)
12. Используйте подкоманду CLI <code><a href="/ru/docs/explanation/bencher-run/">bencher run</a></code>
    для отслеживания бенчмарков брэнча в вашем форке.
    Полный обзор см. в [подкоманде `bencher run` для CLI][bencher run].
    (например, `bencher run`)
13. Установите параметр `--project` в значение Project slug.
    Подробности смотрите в [документации `--project`][project option].
    (например, `--project project-abc4567-wxyz123456789`)
14. Установите параметр `--token` в значение секрета **Repository** `BENCHER_API_TOKEN`.
    Подробности смотрите в [документации `--token`][token option].
    (например, `--token '${{ secrets.BENCHER_API_TOKEN }}'`)
15. Установите параметр `--branch` на имя ветки PR форка
    с использованием [промежуточной переменной среды][github intermediate environment variable].
    Полный обзор см. в [документации `--branch`][branch option].
    (например, `--branch "$PR_HEAD"`)
16. Установите параметр `--hash` в `git` hash ветки PR форка
    с использованием [промежуточной переменной среды][github intermediate environment variable].
    Полный обзор см. в [документации `--hash`][hash option].
    (например, `--hash "$PR_HEAD_SHA"`)
17. Установите Начальную Точку для ветки PR форка:
    1. Установите параметр `--start-point` на начальную точку ветки PR форка
    с использованием [промежуточной переменной среды][github intermediate environment variable].
    Полный обзор см. в [документации `--start-point`][start point].
    (например, `--start-point "$PR_BASE"`)
    2. Установите параметр `--start-point-hash` в `git` hash начальной точки ветки PR форка
    с использованием [промежуточной переменной среды][github intermediate environment variable].
    Полный обзор см. в [документации `--start-point-hash`][start point hash].
    (например, `--start-point-hash "$PR_BASE_SHA"`)
    3. Установите флаг `--start-point-clone-thresholds`, чтобы клонировать Пороги с начальной точки.
    Полный обзор см. в [документации `--start-point-clone-thresholds`][start point clone thresholds].
    (например, `--start-point-clone-thresholds`)
    4. Установите флаг `--start-point-reset` для всегда сбрасывания ветки PR форка к начальной точке.
    Это предотвратит сдвиг данных бенчмарков.
    Полный обзор см. в [документации `--start-point-reset`][start point reset].
    (например, `--start-point-reset`)
18. Установите параметр `--testbed` на имя Testbed.
    Это должно совпадать с машиной, выбранной в `runs-on`.
    Подробности смотрите в [документации `--tested`][testbed option].
    (например, `--testbed ubuntu-latest`)
19. Установите флаг `--err`, чтобы команда завершилась неудачно, если сгенерируется Уведомление.
   Полный обзор см. в [документации `--err`][alert err].
   (например, `--err`)
20. Установите параметр `--adapter` в значение [Bencher Metric Format JSON (`json`)][bmf], который генерируется <code><a href="/ru/docs/reference/bencher-metric-format/#bencher-mock">bencher mock</a></code>.
   Полный обзор см. в [документации адаптеров][adapter json].
   (например, `--adapter json`)
21. Установите параметр `--github-actions` на значение токена аутентификации GitHub API для публикации результатов в виде комментария к Pull Request, используя
    [переменную среды `GITHUB_TOKEN` GitHub Actions][github token].
    Подробности смотрите в [документации `--github-actions`][github actions option].
    (например, `--github-actions '${{ secrets.GITHUB_TOKEN }}'`)
22. Установите параметр `--ci-number` на номер pull request,
    используя [промежуточную переменную среды][github intermediate environment variable].
    Подробности смотрите в [документации `--ci-number`][ci number option].
    (например, `--ci-number "$PR_NUMBER"`)
23. Установите параметр `--file` на путь к файлу с результатами бенчмарков.
    Полный обзор см. в [документации о команде бенчмарков][command argument].
    (например, `--file "$BENCHMARK_RESULTS"`)

[github actions workflow_run]: https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#workflow_run
[github token permissions]: https://docs.github.com/ru/actions/using-jobs/assigning-permissions-to-jobs#setting-the-github_token-permissions-for-a-specific-job
[github token read only]: https://github.blog/changelog/2023-02-02-github-actions-updating-the-default-github_token-permissions-to-read-only/
[github token permissions security]: https://docs.github.com/ru/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token
[github actions runs-on]: https://docs.github.com/ru/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
[github intermediate environment variable]: https://docs.github.com/ru/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions#using-an-intermediate-environment-variable
[action download artifact]: https://github.com/dawidd6/action-download-artifact
[bencher cli github action]: https://github.com/marketplace/actions/bencher-cli
[github action pull_request]: https://docs.github.com/ru/webhooks/webhook-events-and-payloads#pull_request
[github token]: https://docs.github.com/ru/actions/security-guides/automatic-token-authentication

[bencher run]: /ru/docs/explanation/bencher-run/
[project option]: /ru/docs/explanation/bencher-run/#--project-project
[token option]: /ru/docs/explanation/bencher-run/#--token-token
[branch option]: /ru/docs/explanation/branch-selection/#--branch-branch
[hash option]: /ru/docs/explanation/branch-selection/#--hash-hash
[start point]: /ru/docs/explanation/branch-selection/#--start-point-branch
[start point hash]: /ru/docs/explanation/branch-selection/#--start-point-hash-hash
[start point clone thresholds]: /ru/docs/explanation/branch-selection/#--start-point-clone-thresholds
[start point reset]: /ru/docs/explanation/branch-selection/#--start-point-reset
[testbed option]: /ru/docs/explanation/bencher-run/#--testbed-testbed
[alert err]: /ru/docs/explanation/thresholds/#--err
[bmf]: /ru/docs/reference/bencher-metric-format/
[adapter json]: /ru/docs/explanation/adapters/#-json
[github actions option]: /ru/docs/explanation/bencher-run/#--github-actions-github_token
[ci number option]: /ru/docs/explanation/bencher-run/#--ci-id-id
[command argument]: /ru/docs/explanation/bencher-run/#benchmark-command
