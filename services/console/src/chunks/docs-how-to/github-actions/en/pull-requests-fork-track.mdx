import PullRequestsForkTrackCode from "../pull-requests-fork-track-code.mdx";

<PullRequestsForkTrackCode />

1. Create a first GitHub Actions `workflow` file.
   (ex: `.github/workflows/fork_pr_benchmarks_track.yml`)
2. Name this workflow second workflow.
   (ex: `name: Track Benchmarks with Bencher`)
3. Chain the two workflows with
   [the `workflow_run` event][github actions workflow_run].
   (ex: `on: workflow_run: ...`)
4. Create a GitHub Actions `job`.
   (ex: `jobs: track_fork_pr_branch`)
5. Only run this job if the previous workflow's conclusion was a success using
   [the GitHub Actions `workflow_run` event][github actions workflow_run].
   (ex: `if: github.event.workflow_run.conclusion == 'success'`)
6. Set [the permissions for the `GITHUB_TOKEN`][github token permissions]
   to `write` for `pull-requests`.
   Depending on your GitHub settings, this may not be required.
   But for all organizations and personal repos
   [created after 02 Feb 2023][github token read only],
   this is the default behavior.
   See [the GitHub documentation][github token permissions security]
   for a full overview.
   (ex: `permissions: pull-requests: write`)
7. Set the type of machine the job will run on.
   See the [GitHub Actions `runs-on` documentation][github actions runs-on]
   for a full overview.
   (ex: `runs-on: ubuntu-latest`)
8. Set the benchmark results and `pull_request` event object file names as environment variables.
   (ex: `env: ...`)
9. Download the cached benchmark results and `pull_request` event
   using [the `action-download-artifact` GitHub Action][action download artifact].
   (ex: `uses: dawidd6/action-download-artifact@v6`)
10. Export the necessary data from the `pull_request` event as [intermediate environment variables][github intermediate environment variable].
    (ex: `core.exportVariable(...)`)
11. Install the Bencher CLI using [the GitHub Action][bencher cli github action].
   (ex: `uses: bencherdev/bencher@main`)
12. Use the <code><a href="/docs/explanation/bencher-run/">bencher run</a></code> CLI subcommand
    to track your fork pull branch benchmarks.
    See [the `bencher run` CLI subcommand][bencher run] for a full overview.
    (ex: `bencher run`)
13. Set the `--project` option to the Project slug.
    See [the `--project` docs][project option] for more details.
    (ex: `--project project-abc4567-wxyz123456789`)
14. Set the `--token` option to the `BENCHER_API_TOKEN` **Repository** secret.
    See [the `--token` docs][token option] for more details.
    (ex: `--token '${{ secrets.BENCHER_API_TOKEN }}'`)
15. Set the `--branch` option to the fork PR branch name
    using [an intermediate environment variable][github intermediate environment variable].
    See [the `--branch` docs][branch option] for a full overview.
    (ex: `--branch "$PR_HEAD"`)
16. Set the `--hash` option to the fork PR branch `git` hash
    using [an intermediate environment variable][github intermediate environment variable].
    See [the `--hash` docs][hash option] for a full overview.
    (ex: `--hash "$PR_HEAD_SHA"`)
17. Set the Start Point for the fork PR Branch:
    1. Set the `--start-point` option to the fork PR Branch start point
    using [an intermediate environment variable][github intermediate environment variable].
    See [the `--start-point` docs][start point] for a full overview.
    (ex: `--start-point "$PR_BASE"`)
    2. Set the `--start-point-hash` option to the fork PR Branch start point `git` hash
    using [an intermediate environment variable][github intermediate environment variable].
    See [the `--start-point-hash` docs][start point hash] for a full overview.
    (ex: `--start-point-hash "$PR_BASE_SHA"`)
    3. Set the `--start-point-clone-thresholds` flag to clone the Thresholds from the start point.
    See [the `--start-point-clone-thresholds` docs][start point clone thresholds] for a full overview.
    (ex: `--start-point-clone-thresholds`)
    4. Set the `--start-point-reset` flag to always reset the fork PR Branch to the start point.
    This will prevent benchmark data drift.
    See [the `--start-point-reset` docs][start point reset] for a full overview.
    (ex: `--start-point-reset`)
18. Set the `--testbed` option to the Testbed name.
    This should likely match the machine selected in `runs-on`.
    See [the `--tested` docs][testbed option] for more details.
    (ex: `--testbed ubuntu-latest`)
19. Set the `--err` flag to fail the command if an Alert is generated.
   See [the `--err` docs][alert err] for a full overview.
   (ex: `--err`)
20. Set the `--adapter` option to [Bencher Metric Format JSON (`json`)][bmf] that is generated by <code><a href="/docs/reference/bencher-metric-format/#bencher-mock">bencher mock</a></code>.
   See [benchmark harness adapters][adapter json] for a full overview.
   (ex: `--adapter json`)
21. Set the `--github-actions` option to the GitHub API authentication token to post results as a comment on the Pull Request using
    [the GitHub Actions `GITHUB_TOKEN` environment variable][github token].
    See [the `--github-actions` docs][github actions option] for more details.
    (ex: `--github-actions '${{ secrets.GITHUB_TOKEN }}'`)
22. Set the `--ci-number` option to the pull request number
    using [an intermediate environment variable][github intermediate environment variable].
    See [the `--ci-number` docs][ci number option] for more details.
    (ex: `--ci-number "$PR_NUMBER"`)
23. Set the `--file` option to the benchmark results file path.
    See [benchmark command][command argument] for a full overview.
    (ex: `--file "$BENCHMARK_RESULTS"`)

[github actions workflow_run]: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run
[github token permissions]: https://docs.github.com/en/actions/using-jobs/assigning-permissions-to-jobs#setting-the-github_token-permissions-for-a-specific-job
[github token read only]: https://github.blog/changelog/2023-02-02-github-actions-updating-the-default-github_token-permissions-to-read-only/
[github token permissions security]: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token
[github actions runs-on]: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
[github intermediate environment variable]: https://docs.github.com/en/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions#using-an-intermediate-environment-variable
[action download artifact]: https://github.com/dawidd6/action-download-artifact
[bencher cli github action]: https://github.com/marketplace/actions/bencher-cli
[github action pull_request]: https://docs.github.com/en/webhooks/webhook-events-and-payloads#pull_request
[github token]: https://docs.github.com/en/actions/security-guides/automatic-token-authentication

[bencher run]: /docs/explanation/bencher-run/
[project option]: /docs/explanation/bencher-run/#--project-project
[token option]: /docs/explanation/bencher-run/#--token-token
[branch option]: /docs/explanation/branch-selection/#--branch-branch
[hash option]: /docs/explanation/branch-selection/#--hash-hash
[start point]: /docs/explanation/branch-selection/#--start-point-branch
[start point hash]: /docs/explanation/branch-selection/#--start-point-hash-hash
[start point clone thresholds]: /docs/explanation/branch-selection/#--start-point-clone-thresholds
[start point reset]: /docs/explanation/branch-selection/#--start-point-reset
[testbed option]: /docs/explanation/bencher-run/#--testbed-testbed
[alert err]: /docs/explanation/thresholds/#--err
[bmf]: /docs/reference/bencher-metric-format/
[adapter json]: /docs/explanation/adapters/#-json
[github actions option]: /docs/explanation/bencher-run/#--github-actions-github_token
[ci number option]: /docs/explanation/bencher-run/#--ci-id-id
[command argument]: /docs/explanation/bencher-run/#benchmark-command
