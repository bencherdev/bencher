name: Claude Code Review

on:
  pull_request:
    branches: [main, cloud, devel]
    types: [opened, synchronize, reopened, labeled]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  CLAUDE_MODEL: claude-opus-4-5-20251101
  CLAUDE_MAX_TURNS: 10

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-22.04
    if: contains(github.event.pull_request.labels.*.name, 'claude')
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Review
        id: review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          claude -p "Review the changes in this pull request. Use git diff ${{ github.event.pull_request.base.ref }}...HEAD to see the changes. Focus on:
          - Code quality and best practices
          - Potential bugs or issues
          - Security concerns
          - Performance implications
          - Compliance with the project standards outlined in CLAUDE.md

          Provide a concise review in markdown format." \
            --max-turns "${{ env.CLAUDE_MAX_TURNS }}" \
            --model "${{ env.CLAUDE_MODEL }}" \
            --allowedTools "Bash(git diff *),Bash(git log *),Bash(git show *),Read,Grep,Glob" \
            > /tmp/review_output.md 2>&1 || {
            echo "Claude Code review encountered an error" > /tmp/review_output.md
            echo "" >> /tmp/review_output.md
            echo "‚ö†Ô∏è The automated review encountered an error. Please review manually." >> /tmp/review_output.md
          }
        continue-on-error: true

      - name: Post review as PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let review = '';

            try {
              review = fs.readFileSync('/tmp/review_output.md', 'utf8');
            } catch (error) {
              review = '‚ö†Ô∏è Unable to read review output. The review may have failed.';
            }

            // Marker to identify our comment
            const COMMENT_MARKER = '<!-- claude-code-review -->';

            // Add header and metadata
            const body = `${COMMENT_MARKER}
            ## ü§ñ Claude Code Review

            **PR**: #${{ github.event.pull_request.number }}
            **Base**: \`${{ github.event.pull_request.base.ref }}\`
            **Head**: \`${{ github.event.pull_request.head.ref }}\`
            **Commit**: \`${{ github.event.pull_request.head.sha }}\`

            ---

            ${review}

            ---

            <sub>Model: ${{ env.CLAUDE_MODEL }}</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c => c.body.includes(COMMENT_MARKER));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
