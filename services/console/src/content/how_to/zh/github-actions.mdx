---
title: "GitHub æ“ä½œ"
description: "åœ¨ GitHub æ“ä½œä¸­ä½¿ç”¨ Bencher è¿›è¡ŒæŒç»­çš„åŸºçº¿æµ‹è¯•"
heading: "å¦‚ä½•åœ¨ GitHub æ“ä½œä¸­ä½¿ç”¨ Bencher"
sortOrder: 3
---

```
on:
  push:
    branches: main

jobs:
  benchmark_with_bencher:
    name: ä½¿ç”¨ Bencher è·Ÿè¸ªåŸºå‡†
    runs-on: ubuntu-latest
    env:
      BENCHER_PROJECT: save-walter-white
      BENCHER_API_TOKEN: \${{ secrets.BENCHER_API_TOKEN }}
      BENCHER_ADAPTER: json
      BENCHER_TESTBED: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: bencherdev/bencher@main
      - name: ä½¿ç”¨ Bencher è¿›è¡ŒåŸºå‡†æµ‹è¯•
        run: |
          bencher run \\
          --if-branch "$GITHUB_REF_NAME" \\
          --else-if-branch "$GITHUB_BASE_REF" \\
          --else-if-branch main \\
          --err \\
          --github-actions \${{ secrets.GITHUB_TOKEN }} \\
          "bencher mock"
```

1. åˆ›å»º GitHub æ“ä½œ`workflow` ï¼ˆä¾‹å¦‚ï¼š`.github/workflows/benchmark.yml`ï¼‰ã€‚
2. æŒ‡å®š workflow åº”è¿è¡Œ`on`çš„äº‹ä»¶ã€‚æŸ¥çœ‹å®Œæ•´æ¦‚è¿°ï¼Œå¯ä»¥æŸ¥é˜… [GitHub æ“ä½œ `on` æ–‡æ¡£](https://docs.github.com/zh/actions/using-workflows/workflow-syntax-for-github-actions#on)ã€‚æ­¤å·¥ä½œæµ**ä»…**åœ¨ `push` äº‹ä»¶å‘ç”Ÿåˆ° `main` åˆ†æ”¯æ—¶è¿è¡Œã€‚æœ‰å…³åœ¨ [Pull Requests ä¸‹æ–¹æŸ¥çœ‹ç›¸å…³éƒ¨åˆ†](#pull-requests)çš„è¿è¡Œæ–¹å¼ã€‚
3. åˆ›å»º GitHub æ“ä½œ`job` ï¼ˆä¾‹å¦‚ï¼š`benchmark_with_bencher`ï¼‰ã€‚
4. é¡¹ç›®å¿…é¡»å·²å­˜åœ¨ã€‚å°† `--project` æ ‡å¿—æˆ– `BENCHER_PROJECT` ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºé¡¹ç›®çš„ slug æˆ– UUIDã€‚ (ä¾‹å¦‚: `BENCHER_PROJECT: save-walter-white`ï¼‰
5. å°† `BENCHER_API_TOKEN` æ·»åŠ åˆ°æ‚¨çš„**ä»“åº“**ç§˜å¯†ä¸­ï¼ˆä¾‹å¦‚ï¼š`https://github.com/USERNAME/REPO/settings/secrets/actions`ï¼‰
6. API ä»¤ç‰Œå¿…é¡»å·²å­˜åœ¨ã€‚å°† `--token` æ ‡å¿—æˆ– `BENCHER_API_TOKEN` ç¯å¢ƒå˜é‡è®¾ç½®ä¸º API ä»¤ç‰Œã€‚ (ä¾‹å¦‚ï¼š`BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}`)
7. å¯é€‰ï¼šå°† `--adapter` æ ‡å¿—æˆ– `BENCHER_ADAPTER` ç¯å¢ƒå˜é‡è®¾ç½®ä¸ºæ‰€éœ€çš„é€‚é…å™¨åç§°ã€‚å¦‚æœæœªè®¾ç½®æ­¤é€‰é¡¹ï¼Œé‚£ä¹ˆå°†ä½¿ç”¨ `magic` é€‚é…å™¨ã€‚æŸ¥çœ‹å®Œæ•´æ¦‚è¿°ï¼Œå¯ä»¥æŸ¥é˜…å…³äº [åŸºå‡†æµ‹è¯•é€‚é…å™¨](/docs/zh/explanation/adapters) æ–‡æ¡£ã€‚ (ä¾‹å¦‚ï¼š`BENCHER_ADAPTER: json`)
8. å¯é€‰ï¼šå°† `--testbed` æ ‡å¿—æˆ– `BENCHER_TESTBED` ç¯å¢ƒå˜é‡è®¾ç½®ä¸º Testbed çš„ slug æˆ– UUIDã€‚Testbed **å¿…é¡»** å·²å­˜åœ¨ã€‚å¦‚æœæœªè®¾ç½®æ­¤é¡¹ï¼Œé‚£ä¹ˆå°†ä½¿ç”¨ `localhost` Testbedã€‚ (ä¾‹å¦‚ï¼š`BENCHER_TESTBED: ubuntu-latest`)
9. æ£€å‡ºæ‚¨çš„æºä»£ç ã€‚ (ä¾‹å¦‚ï¼š`uses: actions/checkout@v3`ï¼‰
10. ä½¿ç”¨ [GitHub Action](https://github.com/marketplace/actions/bencher-cli) å®‰è£… Bencher CLIã€‚ï¼ˆä¾‹å¦‚ï¼š`uses: bencherdev/bencher@main`ï¼‰
11. ä½¿ç”¨ <code><a href="/docs/zh/explanation/bencher-run">bencher run</a></code> CLI å­å‘½ä»¤ [è·Ÿè¸ªæ‚¨çš„åŸºçº¿](/docs/zh/how-to/track-benchmarks) :
    1. æœ‰å‡ ä¸ªé€‰é¡¹å¯ç”¨äºè®¾ç½®é¡¹ç›®åˆ†æ”¯ã€‚æŸ¥çœ‹å®Œæ•´æ¦‚è¿°ï¼Œå¯ä»¥æŸ¥é˜…å…³äº [åˆ†æ”¯é€‰æ‹©](/docs/zh/how-to/branch-selection) çš„æ–‡æ¡£ã€‚æä¾›çš„å‘½ä»¤ä½¿ç”¨ [GitHub æ“ä½œé»˜è®¤ç¯å¢ƒå˜é‡](https://docs.github.com/zh/actions/learn-github-actions/variables#default-environment-variables)å¹¶å°è¯•ï¼š
        1. å¦‚æœå·²å­˜åœ¨ï¼Œé‚£ä¹ˆä½¿ç”¨å½“å‰åˆ†æ”¯æ•°æ®ã€‚ (ä¾‹å¦‚ï¼š`--if-branch "$GITHUB_REF_NAME"`)
        2. å¦‚æœå·²å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»ºPRç›®æ ‡åˆ†æ”¯æ•°æ®å’Œé˜ˆå€¼çš„å…‹éš†ç‰ˆæœ¬ã€‚ (ä¾‹å¦‚ï¼š`--else-if-branch "$GITHUB_BASE_REF"`)
        3. å¦åˆ™ï¼Œåˆ›å»º `main` åˆ†æ”¯æ•°æ®å’Œé˜ˆå€¼çš„å…‹éš†ç‰ˆæœ¬ã€‚ (ä¾‹å¦‚ï¼š`--else-if-branch main`)
    2. è‹¥äº§ç”Ÿäº†è­¦æŠ¥ï¼Œåˆ™è®¾å®šå‘½ä»¤å¤±è´¥ã€‚ä¸ºäº†äº§ç”Ÿè­¦æŠ¥ï¼Œå¿…é¡»å·²å­˜åœ¨ [é˜ˆå€¼](/docs/zh/explanation/thresholds)ã€‚ (ä¾‹å¦‚ï¼š`--err`)
    3. è®¾å®š _GitHub API éªŒè¯ä»¤ç‰Œ_ ï¼ˆä¾‹å¦‚ï¼š`--github-actions ${{ secrets.GITHUB_TOKEN }}`ï¼‰ã€‚å½“æ­¤é¡¹è®¾ç½®ä¸º pull request çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œç»“æœå°†ä¼šä»¥è¯„è®ºçš„å½¢å¼æ·»åŠ åˆ° pull request ä¸­ã€‚æ­¤æä¾›çš„å‘½ä»¤ä½¿ç”¨ [GitHub æ“ä½œ `GITHUB_TOKEN` ç¯å¢ƒå˜é‡](https://docs.github.com/zh/actions/security-guides/automatic-token-authentication)ã€‚
    4. è¿è¡Œæ‚¨çš„åŸºçº¿å¹¶ä»ç»“æœä¸­ç”ŸæˆæŠ¥å‘Šã€‚ (ä¾‹å¦‚ï¼š`"bencher mock"`ï¼‰

<br/>

## Pull Requests

ä¸ºäº†åœ¨ Pull Requests ä¸­æ•è·æ€§èƒ½å›å½’ï¼Œä½ éœ€è¦åœ¨ PRs ä¸­è¿è¡Œä½ çš„åŸºå‡†æµ‹è¯•ã€‚
å¦‚æœä½ åªæ˜¯æœŸæœ›åœ¨åŒä¸€ä»“åº“å†…æœ‰ PRsï¼Œç„¶åä½ å¯ä»¥ç®€å•åœ°ä¿®æ”¹ä¸Šé¢çš„ä¾‹å­ä»¥åœ¨ `pull_request` äº‹ä»¶ä¸Šè¿è¡Œã€‚

```
on:
  push:
    branches: main
  pull_request:
```

é™åˆ¶åœ¨ `push` ä¸Šè¿è¡Œ**ä»…é™**äºé€‰æ‹©çš„åˆ†æ”¯ï¼ˆä¾‹å¦‚ï¼š`main`ï¼‰æ˜¯é‡è¦çš„ï¼Œé˜²æ­¢æ¨é€åˆ° PR åˆ†æ”¯çš„æ“ä½œè¿è¡Œä¸¤æ¬¡ï¼
å†è¯´ä¸€æ¬¡ï¼Œè¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨æ‰€æœ‰ PRs éƒ½æ¥è‡ª**åŒä¸€ä¸ª**ä»“åº“æ—¶æ‰å¯è¡Œã€‚

å¦‚æœä½ æ‰“ç®—æ¥å—æ¥è‡ª fork çš„ Pull Requestsï¼Œè¿™åœ¨å…¬å¼€çš„å¼€æºé¡¹ç›®ä¸­å¾€å¾€æ˜¯å¸¸è§çš„ï¼Œ
é‚£ä¹ˆä½ éœ€è¦å¤„ç†ä¸€äº›ä¸å¤ªä¸€æ ·çš„äº‹æƒ…ã€‚
å‡ºäºå®‰å…¨åŸå› ï¼Œåƒä½ çš„ `BENCHER_API_TOKEN` å’Œ `GITHUB_TOKEN` è¿™æ ·çš„ç§˜å¯†åœ¨ GitHub æ“ä½œçš„ fork PRs ä¸­æ˜¯ä¸å¯ç”¨çš„ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªå¤–éƒ¨è´¡çŒ®è€…ä»ä¸€ä¸ª fork å¼€å¯ä¸€ä¸ª PRï¼Œä¸Šé¢çš„ä¾‹å­å°±ä¸ä¼šå·¥ä½œã€‚
å¯¹äº fork PRsï¼Œæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š

<ul>
  <li>[å¯¹ç›®æ ‡åˆ†æ”¯åŸºå‡†æµ‹è¯• PR åˆ†æ”¯](#benchmark-pr-branch-from-target-branch)</li>
  <li>[ç¼“å­˜ PR åˆ†æ”¯åŸºå‡†æµ‹è¯•ç»“æœå¹¶ä»é»˜è®¤åˆ†æ”¯ä¸Šä¼ ](#cache-pr-benchmark-results)</li>
</ul>

### å¯¹ç›®æ ‡åˆ†æ”¯åŸºå‡†æµ‹è¯• PR åˆ†æ”¯

1. è§¦å‘ [åœ¨ `pull_request_target` äº‹ä»¶ä¸Š](https://docs.github.com/zh/actions/using-workflows/events-that-trigger-workflows#pull_request_target)ã€‚
2. æ£€å‡º PR åˆ†æ”¯ã€‚
3. ç›´æ¥ä½¿ç”¨ `bencher run` è¿è¡Œå¹¶è·Ÿè¸ªä½ çš„ PR åŸºçº¿ã€‚

è¿™ä¸ªå·¥ä½œæ˜¯å› ä¸º `pull_request_target` æ˜¯åœ¨ pull request çš„ç›®æ ‡åˆ†æ”¯çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„ï¼Œ
åœ¨é‚£é‡Œåƒä½ çš„ `BENCHER_API_TOKEN` å’Œ `GITHUB_TOKEN` è¿™æ ·çš„ç§˜å¯†æ˜¯å¯ç”¨çš„ã€‚
å› æ­¤ï¼Œè¿™ä¸ªå·¥ä½œæµå°†åªä¼šåœ¨ç›®æ ‡åˆ†æ”¯å­˜åœ¨æ—¶è¿è¡Œã€‚
é¿å…å°†ä»»ä½•ç§˜å¯†è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œæ¯”å¦‚ `BENCHER_API_TOKEN`ã€‚
ç›¸åï¼Œå°† API ä»¤ç‰Œæ˜ç¡®ä¼ ç»™ `bencher run` ï¼ˆä¾‹å¦‚ï¼š`--token ${{ secrets.BENCHER_API_TOKEN }}`ï¼‰ã€‚
æŸ¥çœ‹å®Œæ•´æ¦‚è¿°ï¼Œå¯ä»¥æŸ¥é˜… [GitHub Security Lab æ–‡ç« ](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/) å’Œ [åšå®¢æ–‡ç« ] (https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
å…³äºé˜»æ­¢ pwn æŒ‡ä»¤è¯·æ±‚çš„æ–‡æ¡£ã€‚

```
on: pull_request_target

jobs:
  benchmark_with_bencher:
    name: ä½¿ç”¨ Bencher è·Ÿè¸ªåŸºå‡†
    runs-on: ubuntu-latest
    env:
      BENCHER_PROJECT: save-walter-white
      BENCHER_ADAPTER: json
      BENCHER_TESTBED: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: bencherdev/bencher@main
      - name: ä½¿ç”¨ Bencher è¿›è¡ŒåŸºå‡†æµ‹è¯•
        run: |
          bencher run \\
          --if-branch "${{ github.event.pull_request.head.ref }}" \\
          --else-if-branch "${{ github.event.pull_request.base.ref }}" \\
          --else-if-branch main \\
          --err \\
          --github-actions \${{ secrets.GITHUB_TOKEN }} \\
          --token ${{ secrets.BENCHER_API_TOKEN }} \\
          "bencher mock"
```

### ç¼“å­˜ PR åŸºå‡†æµ‹è¯•ç»“æœ

1. åœ¨ `pull_request` é¢˜ä¸Šè¿è¡Œä½ çš„ PR åŸºå‡†ã€‚
1. å°† PR åŸºå‡†ç»“æœä¿å­˜åˆ°æ–‡ä»¶å¹¶ä½œä¸ºä¸€ä¸ªå·¥ä»¶ä¸Šä¼ ã€‚
1. å°† PR äº‹ä»¶ä½œä¸ºä¸€ä¸ªå·¥ä»¶ä¸Šä¼ ã€‚
1. ç”¨[åœ¨ `workflow_run` äº‹ä»¶ä¸Š](https://docs.github.com/zh/actions/using-workflows/events_that-trigger-workflows#workflow_run)è¿æ¥é‚£ä¸ªå·¥ä½œæµã€‚
1. ä»ç¼“å­˜çš„ PR äº‹ä»¶ä¸­æå–å¿…è¦çš„æ•°æ®ã€‚
1. ä½¿ç”¨ `bencher run` è¿½è¸ªç¼“å­˜çš„PRåŸºå‡†ç»“æœã€‚

è¿™ä¸ªå·¥ä½œæ˜¯å› ä¸º `workflow_run` æ˜¯åœ¨ä»“åº“çš„é»˜è®¤åˆ†æ”¯çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„ï¼Œ
åœ¨é‚£é‡Œåƒä½ çš„ `BENCHER_API_TOKEN` å’Œ `GITHUB_TOKEN` è¿™æ ·çš„ç§˜å¯†æ˜¯å¯ç”¨çš„ã€‚
å› æ­¤ï¼Œè¿™äº›å·¥ä½œæµç¨‹åªä¼šåœ¨é»˜è®¤åˆ†æ”¯å­˜åœ¨æ—¶è¿è¡Œã€‚
æŸ¥çœ‹å®Œæ•´æ¦‚è¿°ï¼Œå¯ä»¥æŸ¥é˜… [ä½¿ç”¨è§¦å‘å·¥ä½œæµçš„æ•°æ®](https://docs.github.com/zh/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow) æ–‡æ¡£ã€‚
åœ¨ `workflow_run` ä¸­æ— æ³•è°ƒç”¨ pull è¯·æ±‚çš„ç¼–å·ï¼Œhead åˆ†æ”¯ï¼Œå’ŒåŸºåº•åˆ†æ”¯ï¼Œå› æ­¤å¿…é¡»è‡ªè¡Œè°ƒç”¨ã€‚

```
name: è¿è¡Œå’Œç¼“å­˜åŸºå‡†

on: pull_request

jobs:
  benchmark:
    name: è¿è¡ŒåŸºå‡†
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: æ¨¡æ‹ŸåŸºå‡†
        run: echo '{"bencher::mock_0": { "latency": { "value": 1.0 }}}' &> benchmark_results.txt
      - uses: actions/upload-artifact@v3
        with:
          name: benchmark_results.txt
          path: ./benchmark_results.txt
      - uses: actions/upload-artifact@v3
        with:
          name: pr_event.json
          path: ${{ env.GITHUB_EVENT_PATH }}
```

```
on:
  workflow_run:
    workflows: [è¿è¡Œå’Œç¼“å­˜åŸºå‡†]
    types:
      - completed

jobs:
  track_with_bencher:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      BENCHER_PROJECT: save-walter-white
      BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
      BENCHER_ADAPTER: json
      BENCHER_TESTBED: ubuntu-latest
      BENCHMARK_RESULTS: benchmark_results.txt
      PR_EVENT: pr_event.json
    steps:
      - name: ä¸‹è½½åŸºå‡†ç»“æœ
        uses: actions/github-script@v6
        with:
          script: |
            function downloadArtifact(artifactName) {
              let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.payload.workflow_run.id,
              });
              let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
                return artifact.name == artifactName
              })[0];
              if (!matchArtifact) {
                core.setFailed(`Failed to find artifact: ${artifactName}`);
              }
              let download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: matchArtifact.id,
                archive_format: 'zip',
              });
              let fs = require('fs');
              fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/${artifactName}.zip`, Buffer.from(download.data));
            }
            downloadArtifact(process.env.BENCHMARK_RESULTS);
            downloadArtifact(process.env.PR_EVENT);
      - name: è§£å‹åŸºå‡†ç»“æœ
        run: |
          unzip $BENCHMARK_RESULTS.zip
          unzip $PR_EVENT.zip
      - name: å¯¼å‡º PR ä¸Šä¸‹æ–‡
        uses: actions/github-script@v6
        with:
          script: |
            let fs = require('fs');
            let prEvent = JSON.parse(fs.readFileSync(process.env.PR_EVENT, {encoding: 'utf8'}));
            fs.appendFileSync(process.env.GITHUB_ENV, `PR_NUMBER=${prEvent.number}`);
            fs.appendFileSync(process.env.GITHUB_ENV, `PR_HEAD=${prEvent.pull_request.head.ref}`);
            fs.appendFileSync(process.env.GITHUB_ENV, `PR_BASE=${prEvent.pull_request.base.ref}`);
      - uses: bencherdev/bencher@main
          - name: ä½¿ç”¨ Bencher è¿½è¸ªåŸºå‡†
            run: |
              bencher run \\
              --if-branch "${{ env.PR_HEAD }}" \\
              --else-if-branch "${{ env.PR_BASE }}" \\
              --else-if-branch main \\
              --err \\
              --github-actions \${{ secrets.GITHUB_TOKEN }} \\
              --ci-number ${{ env.PR_NUMBER }} \\
              --file $BENCHMARK_RESULTS
```

<br/>
<br/>

> ğŸ° æ­å–œï¼æ‚¨å·²ç»å­¦ä¼šå¦‚ä½•åœ¨ GitHub æ“ä½œä¸­ä½¿ç”¨ Bencherï¼ğŸ‰

<br/>

<h2><a href="/docs/zh/explanation/benchmarking">ç»§ç»­é˜…è¯»ï¼šåŸºå‡†æµ‹è¯•æ¦‚è§ˆ â¡</a></h2>