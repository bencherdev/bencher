---
title: "GitHub Actions"
description: "Utilisez Bencher dans GitHub Actions pour des benchmarks continus sur les pull requests"
heading: "Comment utiliser Bencher dans GitHub Actions"
sortOrder: 3
---

import GitHubActions1 from "../../../chunks/how_to/github-actions.1.mdx";
import GitHubActions2 from "../../../chunks/how_to/github-actions.2.mdx";
import GitHubActions3 from "../../../chunks/how_to/github-actions.3.mdx";
import GitHubActions4 from "../../../chunks/how_to/github-actions.4.mdx";
import GitHubActions5 from "../../../chunks/how_to/github-actions.5.mdx";
import GitHubActions6 from "../../../chunks/how_to/github-actions.6.mdx";

<GitHubActions1 />

1. Cr√©ez un `workflow` GitHub Actions (ex: `.github/workflows/benchmark.yml`).
2. Sp√©cifiez les √©v√©nements pour lesquels le workflow doit se lancer `on`. Voir la [documentation `on` de GitHub Actions](https://docs.github.com/fr/actions/using-workflows/workflow-syntax-for-github-actions#on) pour un aper√ßu complet. Ce workflow s'ex√©cute **uniquement** pour les √©v√©nements `push` sur la branche `main`. Pour l'ex√©cution [sur les Pull Requests, voir la section ci-dessous](#pull-requests).
3. Cr√©ez un `job` GitHub Actions (ex: `benchmark_with_bencher`)
4. Le projet doit d√©j√† exister. D√©finissez le drapeau `--project` ou la variable d'environnement `BENCHER_PROJECT` sur le slug ou l'UUID du projet. (ex: `BENCHER_PROJECT: save-walter-white`)
5. Ajoutez `BENCHER_API_TOKEN` comme un secret de **R√©pertoire** (ex: `Repo -> Param√®tres -> Secrets et variables -> Actions -> Nouveau secret de r√©pertoire`)
6. Le token API doit d√©j√† exister. D√©finissez le drapeau `--token` ou la variable d'environnement `BENCHER_API_TOKEN` sur le token API. (ex: `BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}`)
7. Optionnel : D√©finissez le drapeau `--adapter` ou la variable d'environnement `BENCHER_ADAPTER` sur le nom de l'adaptateur d√©sir√©. Si cela n'est pas d√©fini, alors l'adaptateur `magic` sera utilis√©. Voir [les adaptateurs de harnais de benchmark](/docs/fr/explanation/adapters) pour un aper√ßu complet. (ex: `BENCHER_ADAPTER: json`)
8. Optionnel : D√©finissez le drapeau `--testbed` ou la variable d'environnement `BENCHER_TESTBED` sur le slug ou l'UUID du Testbed. Le Testbed **doit** d√©j√† exister. Si cela n'est pas d√©fini, alors le Testbed `localhost` sera utilis√©. (ex: `BENCHER_TESTBED: ubuntu-latest`)
9. R√©cup√©rez votre code source. (ex: `uses: actions/checkout@v3`)
10. Installez le Bencher CLI en utilisant l'[Action GitHub](https://github.com/marketplace/actions/bencher-cli). (ex: `uses: bencherdev/bencher@main`)
11. [Suivez vos benchmarks](/docs/fr/how-to/track-benchmarks) avec la sous-commande CLI de <code><a href="/docs/fr/explanation/bencher-run">bencher run</a></code> :
    1. Il y a plusieurs options pour d√©finir la branche de projet. Voir [la s√©lection de branche](/docs/fr/how-to/branch-selection) pour un aper√ßu complet. La commande fournie utilise [les variables d'environnement par d√©faut des Actions GitHub](https://docs.github.com/fr/actions/learn-github-actions/variables#default-environment-variables) et elle essaie de :
        1. Utiliser les donn√©es de la branche courante si elles existent d√©j√†. (ex: `--if-branch "$GITHUB_REF_NAME"`)
        2. Cr√©er un clone des donn√©es et des seuils de la branche cible de la PR s'ils existent d√©j√†. (ex: `--else-if-branch "$GITHUB_BASE_REF"`)
        3. Sinon, cr√©er un clone des donn√©es et des seuils de la branche `main`. (ex: `--else-if-branch main`)
    2. D√©finissez la commande pour √©chouer si une Alerte est g√©n√©r√©e. Pour qu'une Alerte soit g√©n√©r√©e, un [Seuil](/docs/fr/explanation/thresholds) doit d√©j√† exister. (ex: `--err`)
    3. D√©finissez le token d'authentification de l'API GitHub (ex: `--github-actions ${{ secrets.GITHUB_TOKEN }}`). Lorsque cette option est d√©finie dans le cadre d'une pull request, alors les r√©sultats seront ajout√©s √† la pull request sous forme de commentaire. La commande fournie utilise [la variable d'environnement `GITHUB_TOKEN` des Actions GitHub](https://docs.github.com/fr/actions/security-guides/automatic-token-authentication).
    4. Ex√©cutez vos benchmarks et g√©n√©rez un Rapport √† partir des r√©sultats. (ex: `"bencher mock"`)

<br/>

## Pull Requests

Pour attraper une r√©gression de performance dans les Pull Requests, vous devrez lancer vos benchmarks sur les PRs.
Si vous vous attendez √† n'avoir que des PRs provenant de branches situ√©es dans le m√™me d√©p√¥t, alors vous pouvez simplement modifier l'exemple ci-dessus pour ex√©cuter √©galement `on` les √©v√©nements `pull_request`.

<GitHubActions2 />

Il est important de limiter l'ex√©cution au `push` **uniquement** sur les branches s√©lectionn√©es (ex: `main`)
pour √©viter que les push sur les branches de PR ne s'ex√©cutent deux fois !
Encore une fois, cette solution fonctionne uniquement si toutes les PR sont du **m√™me** d√©p√¥t.

Il peut √©galement √™tre int√©ressant de limiter les ex√©cutions uniquement apr√®s l'ajout d'un certain label (ex: `benchmark`):

<GitHubActions3 />

Si vous pr√©voyez d'accepter des Pull Requests √† partir de forks, comme c'est souvent le cas dans les projets open source publics,
alors vous devrez g√©rer les choses un peu diff√©remment.
Pour des raisons de s√©curit√©, les secrets tels que votre `BENCHER_API_TOKEN` et le `GITHUB_TOKEN` ne sont pas disponibles dans les Actions GitHub pour les PRs de forks.
C'est-√†-dire si un contributeur externe ouvre une PR √† partir d'un fork, l'exemple ci-dessus ne fonctionnera pas.
Il y a trois options pour les PRs de forks :

<ul>
  <li>[Benchmark de la branche PR √† partir de la branche cible](#benchmark-pr-branch-from-target-branch)</li>
  <li>[Benchmark de la branche PR √† partir de la branche cible avec des reviewers requis](#benchmark-pr-branch-from-target-branch-with-required-reviewers)</li>
  <li>[Mise en cache des r√©sultats de benchmark des branches PR et t√©l√©chargement depuis la branche par d√©faut](#cache-pr-benchmark-results)</li>
</ul>

### Benchmark de la branche PR √† partir de la branche cible

<GitHubActions4 />

1. D√©clenchement [sur l'√©v√©nement `pull_request_target`](https://docs.github.com/fr/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
1. R√©cup√©ration de la branche PR.
1. Ex√©cution et suivi de vos benchmarks de PR en utilisant `bencher run` directement.

Cela fonctionne parce que `pull_request_target` fonctionne dans le contexte de la branche cible de la pull request,
o√π les secrets tels que `BENCHER_API_TOKEN` et le `GITHUB_TOKEN` sont disponibles.
Par cons√©quent, ce workflow ne se d√©clenchera que s'il existe sur la branche cible.
√âvitez de d√©finir des secrets en tant que variables d'environnement, tels que `BENCHER_API_TOKEN`.
Passez plut√¥t explicitement le token API √† `bencher run` (ex: `--token ${{ secrets.BENCHER_API_TOKEN }}`).
Voir cette [pr√©sentation du GitHub Security Lab](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)
et [cet article de blog](https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
sur la pr√©vention des requ√™tes malveillantes pour un aper√ßu complet.

### Benchmark de la branche PR √† partir de la branche cible avec des reviewers requis

<GitHubActions5 />

1. D√©clenchement [sur l'√©v√©nement `pull_request_target`](https://docs.github.com/fr/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
1. Si la PR est `interne`, alors continuez ; si la PR est `externe`, attendez une revue requise.
1. R√©cup√©ration de la branche PR.
1. Ex√©cution et suivi de vos benchmarks de PR en utilisant `bencher run` directement.

Cette option est exactement la m√™me que [l'option pr√©c√©dente](#benchmark-pr-branch-from-target-branch)
sauf qu'elle `n√©cessite` l'approbation d'un Reviewer Requis avant chaque ex√©cution.
Pour mettre cela en place, vous devez [cr√©er deux Environnements d'Actions GitHub](https://docs.github.com/fr/actions/deployment/targeting-different-environments/using-environments-for-deployment#using-an-environment)
(ex : `Repo -> Param√®tres -> Environnements -> Nouvel environnement`).
L'environnement `interne` ne requiert pas de `R√®gles de protection de d√©ploiement`.
Cependant, l'environnement `externe` devrait avoir des `Reviewers requis` d√©finis pour ceux qui sont de confiance pour examiner une PR avant un benchmark.

Notez que ceci est diff√©rent de l'option de tag mentionn√©e ci-dessus pour les PR internes.
La solution bas√©e sur les tags ex√©cutera _tout_ travail futur apr√®s avoir √©t√© tagu√©.
Ceci peut √™tre utile si vous voulez uniquement faire un benchmark sur certaines PRs.
Cependant, les tags ne doivent pas √™tre vus comme une mesure de s√©curit√© en soi.

L'approbation bas√©e sur les tags peut √™tre limit√©e √† une ex√©cution unique en restreignant le `on: pull_request_target` √† `types: [labeled]`.
Vous devriez alors retirer et retagger la PR pour chaque approbation ult√©rieure.
√Ä ce stade, vous recr√©ez juste les `R√®gles de protection de d√©ploiement` ci-dessus et vous encombrez l'historique de votre PR.

### Mise en cache des r√©sultats de Benchmark des PR

<GitHubActions6 />

1. Ex√©cutez vos benchmarks de PR sur les √©v√©nements `pull_request`.
1. Enregistrez les r√©sultats des benchmarks de PR dans un fichier et t√©l√©chargez-les en tant qu'artefact.
1. T√©l√©chargez l'√©v√©nement de la PR en tant qu'artefact.
1. Chainez ce workflow avec [l'√©v√©nement `workflow_run`](https://docs.github.com/fr/actions/using-workflows/events-that-trigger-workflows#workflow_run).
1. Extraites les donn√©es n√©cessaires de l'√©v√©nement de la PR mise en cache.
1. Suivez les r√©sultats de benchmark de la PR mise en cache avec `bencher run`.

Cela fonctionne parce que `workflow_run` s'ex√©cute dans le contexte de la branche par d√©faut du d√©p√¥t,
o√π les secrets tels que `BENCHER_API_TOKEN` et le `GITHUB_TOKEN` sont disponibles.
Par cons√©quent, ces workflows ne se d√©rouleront que s'ils existent sur la branche par d√©faut.
Voir [utiliser les donn√©es du workflow d√©clenchant](https://docs.github.com/fr/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow) pour un aper√ßu complet.
Le num√©ro de la pull request, la branche de t√™te et la branche de base utilis√©s dans le workflow initial doivent √™tre explicitement pass√©s car ils ne sont pas disponibles dans `workflow_run`.

<br/>
<br/>

> üê∞ Bravo ! Vous avez appris √† utiliser Bencher dans GitHub Actions ! üéâ

<br/>

<h2><a href="/docs/fr/explanation/benchmarking">Continuez : Vue d'ensemble du Benchmark ‚û°</a></h2>