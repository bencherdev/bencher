---
title: "GitHub Actions"
description: "Use o Bencher nas GitHub Actions para an√°lise cont√≠nua em pull requests"
heading: "Como usar o Bencher no GitHub Actions"
sortOrder: 3
---

import GitHubActions1 from "../../../chunks/how_to/github-actions.1.mdx";
import GitHubActions2 from "../../../chunks/how_to/github-actions.2.mdx";
import GitHubActions3 from "../../../chunks/how_to/github-actions.3.mdx";
import GitHubActions4 from "../../../chunks/how_to/github-actions.4.mdx";
import GitHubActions5 from "../../../chunks/how_to/github-actions.5.mdx";

<GitHubActions1 />

1. Crie um arquivo `workflow` do GitHub Actions. (ex `.github/workflows/benchmarks.yml`)
2. Execute em eventos `push` para a branch `main`. Veja a [documenta√ß√£o `on` do GitHub Actions](https://docs.github.com/pt/actions/using-workflows/workflow-syntax-for-github-actions#on) para uma vis√£o geral completa. Consulte tamb√©m [Pull Requests](#pull-requests) abaixo.
3. Crie um `job` do GitHub Actions. (ex `benchmark_with_bencher`)
4. O Projeto j√° deve existir. Defina a flag `--project` ou a vari√°vel de ambiente `BENCHER_PROJECT` para o slug do Projeto ou UUID (ex: `BENCHER_PROJECT: save-walter-white`).
6. Opcional: Defina a flag `--testbed` ou a vari√°vel de ambiente `BENCHER_TESTBED` para o slug Testbed ou UUID. (ex `BENCHER_TESTBED: ubuntu-latest`) O Testbed **deve** j√° existir. Se n√£o for definido, ent√£o o Testbed `localhost` ser√° usado.
7. Defina a flag `--adapter` ou a vari√°vel de ambiente `BENCHER_ADAPTER` para o nome do adaptador desejado. (ex `BENCHER_ADAPTER: json`) Se isso n√£o for definido, ent√£o o adaptador `magic` ser√° usado. Consulte [adaptadores de sistema de refer√™ncia](/docs/pt/explanation/adapters/) para uma vis√£o geral completa.
8. Fa√ßa checkout do seu c√≥digo fonte. (ex `uses: actions/checkout@v3`)
9. Instale o CLI do Bencher usando a [A√ß√£o do GitHub](https://github.com/marketplace/actions/bencher-cli). (ex `uses: bencherdev/bencher@main`)
10. [Rastreie seus benchmarks](/docs/pt/how-to/track-benchmarks/) com o subcomando `bencher run` do CLI:
    1.  Opcional: Configure a flag `--branch` ou a vari√°vel de ambiente `BENCHER_BRANCH` para o slug da Branch ou UUID. (ex: `--branch main`) A Branch **deve** j√° existir. Se isso n√£o for definido, ent√£o a Branch `main` ser√° usada.
    2. O token API j√° deve existir. Adicione `BENCHER_API_TOKEN` como um segredo do **Reposit√≥rio**. (ex: `Repo -> Configura√ß√µes -> Segredos e vari√°veis -> A√ß√µes -> Novo segredo de reposit√≥rio`) Defina a flag `--token` ou a vari√°vel de ambiente `BENCHER_API_TOKEN` para o token API. (ex: `--token ${{ secrets.BENCHER_API_TOKEN }}`)
    3.  Configure o comando para falhar se um Alerta for gerado. (ex: `--err`) Para que um Alerta seja gerado, um [Limiar](/docs/pt/explanation/thresholds/) j√° deve existir.
    4.  Execute seus benchmarks e gere um Relat√≥rio a partir dos resultados. (ex: `"bencher mock"`)

<br/>

## Pull Requests

Para identificar regress√µes de desempenho em Pull Requests, voc√™ precisa executar seus benchmarks em PRs.
Se voc√™ espera apenas ter PRs de branches dentro do mesmo reposit√≥rio, voc√™ pode simplesmente modificar o exemplo acima para tamb√©m executar `on` eventos `pull_request`.

> ‚ö†Ô∏è Esta solu√ß√£o funciona apenas se todas as PRs forem do mesmo reposit√≥rio!
> Veja [Pull Requests de Forks](#pull-requests-from-forks) abaixo.

<GitHubActions2 />

1. Crie um arquivo `workflow` do GitHub Actions. (ex: `.github/workflows/pr_benchmarks.yml`)
2. Execute em eventos `pull_request` apenas se o pull request for do mesmo reposit√≥rio. Para lidar com Pull Requests de Forks, veja [Pull Requests de Forks](#pull-requests-from-forks) abaixo.
3. [Selecione a branch](http://localhost:3000/docs/pt/explanation/branch-selection/) para usar:
        1. Use os dados da branch atual se j√° existirem. (ex: `--if-branch "$GITHUB_REF_NAME"`)
        2. Crie um clone dos dados e limites da branch alvo do PR, se existirem. (ex: `--else-if-branch "$GITHUB_BASE_REF"`)
        3. Caso contr√°rio, crie uma c√≥pia dos dados e limites da branch `main`. (ex: `--else-if-branch main`)
4. Defina o token de autentica√ß√£o da API do GitHub. (ex: `--github-actions "${{ secrets.GITHUB_TOKEN }}"`) Quando esta op√ß√£o √© definida como parte de um pull request, os resultados ser√£o adicionados ao pull request como um coment√°rio. Isso usa [a vari√°vel de ambiente `GITHUB_TOKEN` das GitHub Actions](https://docs.github.com/pt/actions/security-guides/automatic-token-authentication).
5. Veja a documenta√ß√£o de [execu√ß√£o do bencher](/docs/pt/explanation/bencher-run/) para uma vis√£o geral completa de todas as maneiras de configurar o coment√°rio do pull request com as flags `--ci-*`.
6. (N√£o mostrado) Crie um segundo arquivo `workflow` de GitHub Actions e use o exemplo inicial acima para executar em eventos `push` para a branch `main`. (ex: `.github/workflows/benchmarks.yml`)

## Pull Requests de Forks

Se voc√™ planeja aceitar solicita√ß√µes de pull de forks, como √© frequentemente o caso em projetos de c√≥digo aberto,
ent√£o voc√™ precisar√° lidar com as coisas de maneira um pouco diferente.
Por raz√µes de seguran√ßa, segredos como seu `BENCHER_API_TOKEN` e o `GITHUB_TOKEN` n√£o est√£o dispon√≠veis nas GitHub Actions para PRs de forks.
Ou seja, se um contribuidor externo abrir um PR a partir de um fork, o exemplo acima n√£o funcionar√°.
Existem duas op√ß√µes para PRs de forks:

<ul>
  <li>[Benchmark de PR de Fork na Branch Alvo com Revisores Necess√°rios](#benchmark-fork-pr-from-target-branch-with-required-reviewers)</li>
  <li>[Benchmark de PR de fork e Upload da Branch Default](#benchmark-fork-pr-and-upload-from-default-branch)</li>
</ul>

### Benchmark de PR de Fork na Branch Alvo com Revisores Necess√°rios

> ‚ö†Ô∏è √â **muito**, **muito** importante revisar completamente qualquer PR de um fork antes de aprovar!
> N√£o fazer isso pode resultar em uma solicita√ß√£o de pwn!
>
> Se voc√™ preferir n√£o ter isso pendente, veja [Benchmark Fork PR e Upload a partir do Branch padr√£o](#benchmark-fork-pr-e-upload-a-partir-do-branch-padrao) abaixo.

<GitHubActions3 />

1. Crie um arquivo `workflow` do GitHub Actions. (ex: `.github/workflows/pr_benchmarks.yml`)
1. Execute [em eventos `pull_request_target`](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
1. Crie um `job` chamado `fork_pr_requires_review` que requer aprova√ß√£o de um Required Reviewer antes de cada execu√ß√£o de pull request do fork (`external`).
1. Crie um terceiro `job` que depende de `fork_pr_requires_review`.
   1. Fa√ßa checkout da branch do pull request, mas n√£o persista as credenciais do git. (ex: `persist-credentials: false`)
   2. Use aspas simples em torno de todas as entradas n√£o confi√°veis. (ex: `--if-branch '${{ github.head_ref }}'`)
   3. Passe todos os segredos diretamente. (ex: `--token "${{ secrets.BENCHER_API_TOKEN }}"`)
   4. Execute e rastreie seus benchmarks de pull request com `bencher run`.
1. (N√£o demonstrado) Crie um segundo arquivo `workflow` das GitHub Actions e use o exemplo inicial acima para executar em eventos `push` para a branch `main`. (ex: `.github/workflows/benchmarks.yml`)

Esta configura√ß√£o funciona porque `pull_request_target` √© executado no contexto da branch de destino da solicita√ß√£o de pull,
onde segredos como seu `BENCHER_API_TOKEN` e o `GITHUB_TOKEN` est√£o dispon√≠veis.
Portanto, este fluxo de trabalho s√≥ ser√° executado se existir na branch _alvo_.

Para configurar isso, voc√™ precisa [criar dois GitHub Action Environments](https://docs.github.com/pt/actions/deployment/targeting-different-environments/using-environments-for-deployment#using-an-environment)
(ex: `Repo -> Configura√ß√µes -> Ambientes -> Novo ambiente`).
O ambiente `internal` n√£o deve ter `Regras de prote√ß√£o de deploy`.
No entanto, o ambiente `external` deve ter `Revisores necess√°rios` definido para aqueles confi√°veis para revisar PRs de fork antes de fazer o benchmark.

√â muito importante colocar o nome da branch PR (head ref) entre aspas simples. (ex: `--if-branch '${{ github.head_ref }}'`) Caso contr√°rio, um atacante poderia criar uma branch com um nome malicioso que executa a inje√ß√£o de comando. Veja este [esbo√ßo do GitHub Security Lab](https://securitylab.github.com/research/github-actions-untrusted-input/) sobre a preven√ß√£o de solicita√ß√µes pwn de entrada n√£o confi√°vel para uma vis√£o geral completa.

Evite definir quaisquer segredos como vari√°veis de ambiente, como `GITHUB_TOKEN` e `BENCHER_API_TOKEN`.
Passe explicitamente os segredos para `bencher run`. (ex `--token "${{ secrets.BENCHER_API_TOKEN }}"`)
Veja este [esbo√ßo do GitHub Security Lab](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)
e [este post de blog](https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
sobre como prevenir solicita√ß√µes pwn para uma vis√£o geral completa.

### Benchmark de PR de Fork e Upload da Branch Default

<GitHubActions4 />

1. Crie um arquivo de workflow `Run and Cache Benchmarks`. (ex: `.github/workflows/pr_benchmarks.yml`)
2. Execute todos os jobs no workflow em eventos `pull_request`.
3. Execute os benchmarks e salve os resultados em um arquivo. (ex: `benchmark_results.json`)
4. Carregue o arquivo de resultados do benchmark como um artefato.
5. Carregue o objeto de evento `pull_request` como um artefato.

<GitHubActions5 />

1. Crie um segundo arquivo de workflow, `Track Benchmarks`. (ex: `.github/workflows/track_benchmarks.yml`)
2. Encadeie `Track Benchmarks` para `Run and Cache Benchmarks` com [o evento `workflow_run`](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#workflow_run).
3. Baixe os resultados de benchmark em cache e o evento `pull_request`.
4. Extraia os resultados de benchmark em cache e o evento `pull_request`.
5. Exporte os dados necess√°rios do evento `pull_request` como vari√°veis de ambiente.
6. Rastreie os resultados de benchmark em cache com `bencher run`:
   1. Use aspas simples em torno de todas as entradas n√£o confi√°veis. (ex: `--if-branch '${{ env.PR_HEAD }}'`)
   2. Passe explicitamente o n√∫mero da solicita√ß√£o de pull. (ex: `--ci-number '${{ env.PR_NUMBER }}'`)
   3. Passe o caminho do arquivo para o arquivo de resultados de benchmark. (ex: `--file "$BENCHMARK_RESULTS"`)
1. (N√£o demonstrado) Crie um terceiro arquivo `workflow` das GitHub Actions e use o exemplo inicial acima para executar em eventos `push` para a branch `main`. (ex: `.github/workflows/benchmarks.yml`)

Este setup funciona porque `workflow_run` √© executado no contexto da branch padr√£o do reposit√≥rio,
onde segredos como seu `BENCHER_API_TOKEN` e o `GITHUB_TOKEN` est√£o dispon√≠veis.
Portanto, esses fluxos de trabalho s√≥ ser√£o executados se existirem na branch _padr√£o_.
Veja [usando dados do fluxo de trabalho de acionamento](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow) para uma vis√£o geral completa.
O n√∫mero da pull request, a branch principal e a branch base usadas no fluxo de trabalho inicial devem ser passadas explicitamente, pois n√£o est√£o dispon√≠veis dentro do `workflow_run`.

√â muito importante colocar o nome da branch PR (head ref) entre aspas simples. (ex: `--if-branch '${{ env.PR_HEAD }}'`) Caso contr√°rio, um atacante poderia criar uma branch com um nome malicioso que executa a inje√ß√£o de comando. Veja este [esbo√ßo do GitHub Security Lab](https://securitylab.github.com/research/github-actions-untrusted-input/) sobre a preven√ß√£o de solicita√ß√µes pwn de entrada n√£o confi√°vel para uma vis√£o geral completa.

Evite definir quaisquer segredos como vari√°veis de ambiente no arquivo de workflow `Run and Cache Benchmarks`.
Veja este [esbo√ßo do GitHub Security Lab](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)
e [este post de blog](https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
sobre como prevenir solicita√ß√µes pwn para uma vis√£o geral completa.

<br/>
<br/>

> üéâ Parab√©ns! Voc√™ aprendeu a usar o Bencher nas GitHub Actions! üê∞

<br/>

<h2><a href="/docs/pt/explanation/benchmarking">Continuar: An√°lise de Desempenho ‚û°</a></h2>
