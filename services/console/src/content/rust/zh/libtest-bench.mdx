---
title: "libtest bench"
description: "é€æ­¥æŒ‡å¯¼å¦‚ä½•ä½¿ç”¨libtest benchå¯¹Rustä»£ç è¿›è¡ŒåŸºå‡†æµ‹è¯•"
heading: "å¦‚ä½•ä½¿ç”¨libtest benchå¯¹Rustä»£ç è¿›è¡ŒåŸºå‡†æµ‹è¯•"
published: "2023-10-18T10:28:00Z"
modified: "2024-05-01T17:54:00Z"
sortOrder: 1
---

import Benchmarking from "../../../chunks/benchmarking/zh/benchmarking.mdx";
import FizzBuzzRules from "../../../chunks/benchmarking/zh/fizz-buzz-rules.mdx";
import FizzBuzzRustCode from "../../../chunks/rust/fizz-buzz-rust-code.mdx";
import FizzBuzzRust from "../../../chunks/rust/zh/fizz-buzz-rust.mdx";
import StepByStepRust from "../../../chunks/rust/zh/step-by-step-rust.mdx";
import MicroVsMacro from "../../../chunks/benchmarking/zh/micro-vs-macro.mdx";
import BenchmarkingRust from "../../../chunks/rust/zh/benchmarking-rust.mdx";
import RustToolchainRustBenchCode from "../../../chunks/rust/bench/rust-toolchain-rust-bench-code.mdx";
import RustToolchainRustBenchTree from "../../../chunks/rust/bench/rust-toolchain-rust-bench-tree.mdx";
import FizzBuzzRefactorRust from "../../../chunks/rust/bench/zh/fizz-buzz-refactor-rust.mdx";
import TestCreateRustBenchCode from "../../../chunks/rust/bench/test-crate-rust-bench-code.mdx"
import BenchPlayGameRustBenchCode from "../../../chunks/rust/bench/bench-play-game-rust-bench-code.mdx";
import BenchPlayGameRustBenchOutput from "../../../chunks/rust/bench/bench-play-game-rust-bench-output.mdx";
import FizzBuzzFibonacciRust from "../../../chunks/rust/zh/fizz-buzz-fibonacci-rust.mdx";
import PlayGameRustCode from "../../../chunks/rust/bench/play-game-rust-code.mdx";
import BenchPlayGameFibonacciRustBenchOutput from "../../../chunks/rust/bench/bench-play-game-fibonacci-rust-bench-output.mdx";
import FizzBuzzFibonacciOpenRust from "../../../chunks/rust/zh/fizz-buzz-fibonacci-open-rust.mdx";
import FizzBuzzFibonacciOpenRustCode from "../../../chunks/rust/bench/fizz-buzz-fibonacci-open-rust-code.mdx";
import TheEnd from "../../../chunks/benchmarking/zh/the-end.mdx";
import OnFire from "../../../chunks/benchmarking/zh/on-fire.mdx";
import BenchPlayGameOnFireRustBenchCode from "../../../chunks/rust/bench/bench-play-game-on-fire-rust-bench-code.mdx";
import BenchPlayGameOnFireRustBenchOutputStart from "../../../chunks/rust/bench/bench-play-game-on-fire-rust-bench-output-start.mdx";
import BenchPlayGameOnFireRustBenchOutput from "../../../chunks/rust/bench/bench-play-game-on-fire-rust-bench-output.mdx";
import FizzBuzzFibonacciFixRust from "../../../chunks/rust/zh/fizz-buzz-fibonacci-fix-rust.mdx";
import BenchPlayGameFixRustBenchOutput from "../../../chunks/rust/bench/bench-play-game-fix-rust-bench-output.mdx";
import CatchInCi from "../../../chunks/benchmarking/zh/catch-in-ci.mdx";
import CatchInCiRustBenchOutput from "../../../chunks/rust/bench/catch-in-ci-rust-bench-output.mdx";
import CatchInCiPlot from "../../../chunks/benchmarking/zh/catch-in-ci-plot.mdx";
import CatchInCiPlotRustBench from "../../../chunks/rust/catch-in-ci-plot-rust-bench.mdx";
import BencherFooter from "../../../chunks/learn/zh/bencher-footer.mdx";

<Benchmarking />

<FizzBuzzRust />

<StepByStepRust />

<MicroVsMacro />

<BenchmarkingRust />

æ‰€æœ‰è¿™ä¸‰ä¸ªéƒ½æ˜¯[ç”±Bencheræ”¯æŒ](/zh/docs/explanation/adapters/)ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¦é€‰æ‹©libtest benchå‘¢?
å¦‚æœä½ è¯•å›¾é™åˆ¶é¡¹ç›®çš„å¤–éƒ¨ä¾èµ–ï¼Œå¹¶ä¸”ä½ çš„é¡¹ç›®å·²ç»ä½¿ç”¨äº†`å¤œé—´ç‰ˆ`å·¥å…·é“¾ï¼Œé‚£ä¹ˆè¿™å¯èƒ½æ˜¯ä¸ªå¥½ä¸»æ„ã€‚
é™¤æ­¤ä¹‹å¤–ï¼Œæ ¹æ®ä½ çš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä¼šå»ºè®®ä½¿ç”¨ Criterion æˆ–è€… Iaiã€‚

### å®‰è£…Rust `å¤œé—´ç‰ˆ`

é‚£ä¹ˆè¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬è¦ç”¨åˆ°libtest benchï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å°†Rustå·¥å…·é“¾è®¾ç½®ä¸º`å¤œé—´ç‰ˆ`ã€‚
åœ¨ä½ çš„`game`é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª`rust-toolchain.toml`æ–‡ä»¶ï¼Œä¸`Cargo.toml`åŒçº§ã€‚

<RustToolchainRustBenchCode />

ä½ çš„ç›®å½•ç»“æ„ç°åœ¨åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

<RustToolchainRustBenchTree />

ä¸€æ—¦å®Œæˆï¼Œé‡æ–°è¿è¡Œ`cargo run`ã€‚
æ–°çš„å¤œé—´ç‰ˆå·¥å…·é“¾çš„å®‰è£…åº”è¯¥ä¼šèŠ±è´¹ä¸€ç‚¹æ—¶é—´ï¼Œç„¶åå†é‡æ–°è¿è¡Œï¼Œç„¶åç»™å‡ºå’Œä»¥å‰ä¸€æ ·çš„è¾“å‡ºã€‚

<FizzBuzzRefactorRust />

## å¯¹FizzBuzzè¿›è¡ŒåŸºå‡†æµ‹è¯•

ä¸ºäº†ä½¿ç”¨ä¸ç¨³å®šçš„libtest crateï¼Œæˆ‘ä»¬éœ€è¦å¯ç”¨æˆ‘ä»¬ä»£ç çš„`test`ç‰¹æ€§å¹¶å¯¼å…¥`test` crateã€‚åœ¨`main.rs`çš„_é¡¶éƒ¨_æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

<TestCreateRustBenchCode />

ç°åœ¨æˆ‘ä»¬å‡†å¤‡æ·»åŠ æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªåŸºå‡†æµ‹è¯•ï¼
åœ¨`main.rs`çš„_åº•éƒ¨_æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

<BenchPlayGameRustBenchCode />

- åˆ›å»ºä¸€ä¸ªåä¸º`benchmarks`çš„æ¨¡å—ï¼Œå¹¶è®¾ç½®[ç¼–è¯‘å™¨é…ç½®](https://doc.rust-lang.org/reference/conditional-compilation.html#the-cfg-attribute)ä¸º[`æµ‹è¯•æ¨¡å¼`](https://doc.rust-lang.org/book/ch11-03-test-organization.html#the-tests-module-and-cfgtest)ã€‚
- å¼•å…¥`Bencher`åŸºå‡†æµ‹è¯•è¿è¡Œå™¨ã€‚ï¼ˆğŸ° å“‡ï¼Œé…·åå­—ï¼ï¼‰
- å¼•å…¥æˆ‘ä»¬çš„`play_game`åŠŸèƒ½ã€‚
- åˆ›å»ºä¸€ä¸ªåä¸º`bench_play_game`çš„åŸºå‡†ï¼Œå®ƒæ¥å—ä¸€ä¸ªæŒ‡å‘`Bencher`çš„å¯å˜å¼•ç”¨ã€‚
- è®¾ç½®`#[bench]`å±æ€§ä»¥è¡¨æ˜`bench_play_game`æ˜¯ä¸€ä¸ªåŸºå‡†ã€‚
- ä½¿ç”¨`Bencher`å®ä¾‹ (`b`)å¤šæ¬¡è¿è¡Œæˆ‘ä»¬çš„å®åŸºå‡†ã€‚
- åœ¨ä¸€ä¸ª"é»‘åŒ£å­"é‡Œè¿è¡Œæˆ‘ä»¬çš„å®åŸºå‡†ï¼Œä»¥ä¾¿ç¼–è¯‘å™¨ä¸ä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚
- ä»`1`è¿­ä»£åˆ°`100`ï¼ˆåŒ…å«ï¼‰ã€‚
- å¯¹æ¯ä¸ªæ•°å­—ï¼Œè°ƒç”¨`play_game`ã€‚

ç°åœ¨æˆ‘ä»¬å‡†å¤‡å¯¹æˆ‘ä»¬çš„ä»£ç è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œè¿è¡Œ`cargo bench`ï¼š

<BenchPlayGameRustBenchOutput />

> ğŸ° è®©æˆ‘ä»¬åŠ å¤§èƒ¡èåœçš„åŠ›é‡ï¼æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†æˆ‘ä»¬çš„ç¬¬ä¸€ä»½åŸºå‡†æµ‹è¯•åº¦é‡æ•°æ®ï¼

ç»ˆäºï¼Œæˆ‘ä»¬å¯ä»¥è®©è‡ªå·±ç–²æƒ«çš„å¼€å‘è€…å¤§è„‘ä¼‘æ¯ä¸€ä¸‹...
å¼€ç©ç¬‘çš„ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·æƒ³è¦ä¸€ä¸ªæ–°ç‰¹æ€§ï¼

<FizzBuzzFibonacciRust>
  <PlayGameRustCode />
</FizzBuzzFibonacciRust>

## å¯¹FizzBuzzFibonacciè¿›è¡ŒåŸºå‡†æµ‹è¯•

ç°åœ¨æˆ‘ä»¬å¯ä»¥é‡æ–°è¿è¡Œæˆ‘ä»¬çš„åŸºå‡†ï¼š

<BenchPlayGameFibonacciRustBenchOutput />

å›çœ‹æˆ‘ä»¬çš„ç»ˆç«¯å†å²è®°å½•ï¼Œ
æˆ‘ä»¬å¯ä»¥ç”¨çœ¼ç›æ¯”è¾ƒFizzBuzzå’ŒFizzBuzzFibonacciæ¸¸æˆçš„æ€§èƒ½ï¼š`4,879 ns`å¯¹`22,167 ns`ã€‚
ä½ çš„æ•°å­—å¯èƒ½ä¼šå’Œæˆ‘æœ‰ä¸€ç‚¹ç‚¹ä¸åŒã€‚
ä¸è¿‡ï¼Œä¸¤æ¬¾æ¸¸æˆçš„å·®è·å¯èƒ½åœ¨5å€çš„èŒƒå›´å†…ã€‚
è¿™å¯¹æˆ‘æ¥è¯´çœ‹èµ·æ¥ä¸é”™ï¼ç‰¹åˆ«æ˜¯å¯¹æ·»åŠ äº†åƒ_Fibonacci_è¿™æ ·èŠ±å“¨ sounding çš„åŠŸèƒ½åˆ°æˆ‘ä»¬çš„æ¸¸æˆã€‚
å­©å­ä»¬ä¼šçˆ±ä¸Šå®ƒçš„ï¼

<FizzBuzzFibonacciOpenRust>
  <FizzBuzzFibonacciOpenRustCode />
</FizzBuzzFibonacciOpenRust>

<TheEnd />

<br />

<OnFire />

<BenchPlayGameOnFireRustBenchCode />

- ä¸€ä¸ªå¸¦æœ‰æ•°å­—ä¸€ç™¾ï¼ˆ`100`ï¼‰çš„æ®æ­¤æ¸¸æˆçš„å¾®è§‚åŸºå‡†æµ‹è¯•`bench_play_game_100`
- ä¸€ä¸ªå¸¦æœ‰æ•°å­—ä¸€ç™¾ä¸‡ï¼ˆ`1_000_000`ï¼‰çš„æ®æ­¤æ¸¸æˆçš„å¾®è§‚åŸºå‡†æµ‹è¯•`bench_play_game_1_000_000`

å½“æˆ‘è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘å¾—åˆ°äº†è¿™ä¸ªï¼š

<BenchPlayGameOnFireRustBenchOutputStart />

ç­‰ä¸€ä¸‹... ç­‰ä¸€ä¸‹...

<BenchPlayGameOnFireRustBenchOutput />

ä»€ä¹ˆï¼`439 ns` x `1,000` åº”è¯¥æ˜¯ `439,000 ns`ï¼Œä¸æ˜¯ `9,586,977 ns` ğŸ¤¯
å³ä½¿æˆ‘å¾—åˆ°äº†æ­£ç¡®çš„Fibonacciåºåˆ—ä»£ç ï¼Œæˆ‘è¿˜æ˜¯å¯èƒ½åœ¨æŸå¤„æœ‰æ€§èƒ½bugã€‚

<FizzBuzzFibonacciFixRust />

ç°åœ¨è®©æˆ‘ä»¬é‡æ–°è¿è¡Œé‚£äº›åŸºå‡†ï¼Œçœ‹çœ‹æˆ‘ä»¬åšå¾—æ€ä¹ˆæ ·ï¼š

<BenchPlayGameFixRustBenchOutput />

å“¦ï¼Œå“‡ï¼æˆ‘ä»¬çš„ `bench_play_game` åŸºå‡†åˆå›åˆ°äº†ä¸åŸå§‹çš„FizzBuzzå·®ä¸å¤šçš„åœ°æ–¹ã€‚
æˆ‘å¸Œæœ›æˆ‘è®°å¾—é‚£ä¸ªåˆ†æ•°åˆ°åº•æ˜¯å¤šå°‘ã€‚ä¸è¿‡å·²ç»è¿‡å»ä¸‰å‘¨äº†ã€‚
æˆ‘çš„ç»ˆç«¯å†å²è®°å½•å·²ç»æ— æ³•è¿½æº¯é‚£ä¹ˆé•¿æ—¶é—´äº†ã€‚
ä¸è¿‡æˆ‘æƒ³è¿™ä¸ªåˆ†æ•°åº”è¯¥å’Œå®ƒå¾ˆæ¥è¿‘ï¼

`bench_play_game_100` åŸºå‡†ä¸‹é™äº†å°†è¿‘10å€ï¼Œä»`439 ns`åˆ°`46 ns`ã€‚
è€Œ`bench_play_game_1_000_000`åŸºå‡†ä¸‹é™äº†è¶…è¿‡10,000å€ï¼ `9,586,977 ns` é™åˆ° `53 ns`ï¼

> ğŸ° å—¨ï¼Œè‡³å°‘æˆ‘ä»¬åœ¨è¿™ä¸ªæ€§èƒ½bugè¿›å…¥ç”Ÿäº§ç¯å¢ƒä¹‹å‰å‘ç°äº†å®ƒ...å“¦ï¼Œå¯¹ã€‚å¿˜è®°äº†...

<CatchInCi />

<CatchInCiRustBenchOutput />

<CatchInCiPlot />

<CatchInCiPlotRustBench title="å¦‚ä½•ä½¿ç”¨libtest bench å¯¹Rustè¿›è¡ŒåŸºå‡†æµ‹è¯•" />

<BencherFooter />
