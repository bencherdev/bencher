name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, cloud, devel]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  CLAUDE_MODEL: claude-opus-4-5-20251101
  CLAUDE_MAX_TURNS: 10

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Review
        id: review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          claude /review --max-turns "${{ env.CLAUDE_MAX_TURNS }}" --model "${{ env.CLAUDE_MODEL }}" > /tmp/review_output.md 2>&1 || {
            echo "Claude Code review encountered an error" > /tmp/review_output.md
            echo "" >> /tmp/review_output.md
            echo "‚ö†Ô∏è The automated review encountered an error. Please review manually." >> /tmp/review_output.md
          }
        continue-on-error: true

      - name: Post review as PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let review = '';

            try {
              review = fs.readFileSync('/tmp/review_output.md', 'utf8');
            } catch (error) {
              review = '‚ö†Ô∏è Unable to read review output. The review may have failed.';
            }

            // Add header and metadata
            const comment = `## ü§ñ Claude Code Review

            **PR**: #${{ github.event.pull_request.number }}
            **Base**: \`${{ github.event.pull_request.base.ref }}\`
            **Head**: \`${{ github.event.pull_request.head.ref }}\`

            ---

            ${review}

            ---

            <sub>Model: ${{ env.CLAUDE_MODEL }}</sub>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
